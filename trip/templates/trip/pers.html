{% extends "base_window.html" %}
{% load static %}
{% block content %}

  <script language="javascript" type="text/javascript">

    function getPersLink(_p)
    {
      var html = '<a href="/trip/pers/' + _p +'/">' + _p + '</a>';
      document.write(html);
      return true;
    }

    function getPersMark(_me, _t)
    {
      var html = '';
      if (_me == 1)
        if (_t == 1)
          html = '<div class="marked">';
        else
          html = '</div>';
      document.write(html);
      return true;
    }

    function myClick(_num)
    {
      var frm = document.getElementById("fld_form");
      if (frm.elements["me"].checked)
        frm.elements["me"].value = '1';
      else
        frm.elements["me"].value = '0';
      frm.Submit();
      return true;
    }

    bEdit = false;

    function check()
    {
      var name  = document.getElementById('fld_form').elements['name'].value;
      var dativ = document.getElementById('fld_form').elements['dative'].value;

      var status = '';
      if (name == '' || name == '?')
        status = 'Не задано имя';
      else
        if (dativ == '')
          status = 'Не задано имя в дательном падеже';
      
      document.getElementById('status').innerHTML = status;
      
      var x = document.getElementById('buttons');
      
      if (status != '')
      {
        if (!bEdit)
          x.innerHTML = '';
        else
          x.innerHTML = '<input type="submit" class="LiteButton" id="delete" name="action" value="Удалить"   onClick="myClick(3)" />' +
                        '<input type="submit" class="LiteButton" id="common" name="action" value="Отменить"  onClick="myClick(4)" />';
      }
      else
      {
        if (!bEdit)
          x.innerHTML = '<input type="submit" class="LiteButton" id="update" name="action" value="Добавить"  onClick="myClick(1)" />';
        else
          x.innerHTML = '<input type="submit" class="LiteButton" id="update" name="action" value="Сохранить" onClick="myClick(2)" />' +
                        '<input type="submit" class="LiteButton" id="delete" name="action" value="Удалить"   onClick="myClick(3)" />' +
                        '<input type="submit" class="LiteButton" id="common" name="action" value="Отменить"  onClick="myClick(4)" />';
      }
    }

  </script>

  <div id="gmenu" class="menu"> <a href="/">{{ app_text }}</a> | <a href="/trip">{{ trip_text }}</a> </div>
  <div class="PageTitle">  {{page_title}}  </div>
  <div class="PageStatus"> {{page_status}} </div>

  {{ form.non_field_errors }}
  {% for field in form %}
    <div class="fieldWrapper"> {{ field.errors }} </div>
  {% endfor %}

  <form id="fld_form" action="{% url 'trip:pers_edit' pid %}" method="post">
    {% csrf_token %}
    <input name="pid"    type="hidden" value="{{ pid }}">
    <input name="action" type="hidden" value="none">
    <table class="fl1">
      <tbody>
        {% if pid > 0 %} 
        <script language="javascript" type="text/javascript"> bEdit = true; </script>
        <tr><td class="fl1"> ID: </td><td class="fl2"> {{ pid }} </td> </tr>
        {% else %}
        <script language="javascript" type="text/javascript"> bEdit = false; </script>
        {% endif %}
        <tr><td class="fl1"> Имя:             </td><td class="fl2"> <input name="name"   size="15" type="text" value="{{ cur.name }}"   onChange="check()" /> </td> </tr>
        <tr><td class="fl1"> Дательный падеж: </td><td class="fl2"> <input name="dative" size="15" type="text" value="{{ cur.dative }}" onChange="check()" /> </td> </tr>
        <tr><td class="fl1"> Я:               </td><td class="fl2"> <input name="me" type="checkbox" {% if cur.me > 0 %} checked {% endif %} /> </td> </tr>
      </tbody>
    </table>
    <span id="buttons"> </span> 
    <span id="status" class="PageStatus"> </span> 
    <script language="javascript" type="text/javascript"> check() </script>
  </form>

  {% if pers.count %}
  <table class="work">
    <tbody>
      <tr>
        <th class="work"> ID   </th>
        <th class="work"> Имя  </th>
        <th class="work"> Кому </th>
      </tr>
      {% for p in pers %}
      <tr>
        <td class="pid">  <script language="javascript" type="text/javascript">getPersLink({{ p.id }})</script> </td>
        <td class="work"> <script language="javascript" type="text/javascript">getPersMark({{ p.me }}, 1)</script>
                          {{ p.name   }}
                          <script language="javascript" type="text/javascript">getPersMark({{ p.me }}, 2)</script></td>
        <td class="work"> <script language="javascript" type="text/javascript">getPersMark({{ p.me }}, 1)</script>
                          {{ p.dative }}
                          <script language="javascript" type="text/javascript">getPersMark({{ p.me }}, 2)</script></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  <br/>Всего персон: {{ pers_count }}<br/>

{% endblock %}
