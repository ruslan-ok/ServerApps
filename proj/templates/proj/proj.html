{% extends "base.html" %}
{% load static %}
{% block content %}

  <script language="javascript" type="text/javascript">

    totalSum = 0;
    bEdit = false;
    
    function check()
    {
      var frm = document.getElementById("fld_form");
      var pd = new Date(frm.elements['date'].value);
      var kol = parseFloat(frm.elements['kol'].value);
      var prc = parseFloat(frm.elements['price'].value);
      var crs = parseFloat(frm.elements['course'].value);
      var usd = parseFloat(frm.elements['usd'].value);
      
      var totalSum = 0.0;
      if (!isNaN(crs) && !isNaN(kol) && !isNaN(prc) && (crs != 0) && (kol != 0) && (prc != 0))
        totalSum = (kol * prc) / crs;
      if (!isNaN(usd))
        totalSum += usd;
    
      document.getElementById('total').innerHTML = totalSum.toFixed(2);

      var status = '';
      
      if (isNaN(pd.getDate()))
        status = 'Не задана дата операции';
      else
        if (isNaN(kol) || (kol == 0))
          status = 'Не задано количество';
        else
          if (isNaN(prc) || (prc == 0))
            status = 'Не задана цена';
          else
            if (isNaN(crs) || isNaN(usd) || ((crs == 0) && (usd == 0)))
              status = 'Не задан курс или стоимость в USD';
            else
              if (frm.elements['kontr'].value == '')
                status = 'Не задан контрагент';

      document.getElementById('status').innerHTML = status;
      
      var x = document.getElementById('buttons');
      
      if (status != '')
      {
        if (!bEdit)
          x.innerHTML = '';
        else
          x.innerHTML = '<input type="submit" class="LiteButton" id="delete" name="action" value="Удалить"   onClick="myClick(3)" />' +
                        '<input type="submit" class="LiteButton" id="common" name="action" value="Отменить"  onClick="myClick(4)" />';
      }
      else
      {
        if (!bEdit)
          x.innerHTML = '<input type="submit" class="LiteButton" id="update" name="action" value="Добавить"  onClick="myClick(1)" />';
        else
          x.innerHTML = '<input type="submit" class="LiteButton" id="update" name="action" value="Сохранить" onClick="myClick(2)" />' +
                        '<input type="submit" class="LiteButton" id="delete" name="action" value="Удалить"   onClick="myClick(3)" />' +
                        '<input type="submit" class="LiteButton" id="common" name="action" value="Отменить"  onClick="myClick(4)" />';
      }
    }

    function myClick(_num)
    {
      frm.Submit();
      return true;
    }

    function getLink(_p)
    {
      var html = '<a href="/proj/' + _p +'/">' + _p + '</a>';
      document.write(html);
      return true;
    }

  </script>

  <div id="gmenu" class="menu"> <a href="/"> {{ app_text }} </a> | <a href="/proj/dirs"> {{ direct_text }} </a> </div> <br/>
  <div class="PageTitle"> {{ page_title }} {% for d in dirs %} | <a href="/proj/chg_dir/{{ d.id }}/"> {{ d.name }} </a> {% endfor %} </div>
  <div> {{ proj_summary|safe }} </div>

  <form id="fld_form" action="{% url 'proj:proj_edit' pid %}" method="post">
    {% csrf_token %}
    <table class="fl1"><tbody>
      {% if pid > 0 %} 
      <script language="javascript" type="text/javascript"> bEdit = true; </script>
      <tr><td class="fl1"> ID:            </td><td class="fl2"> {{ pid }} </td> </tr>
      {% else %}
      <script language="javascript" type="text/javascript"> bEdit = false; </script>
      {% endif %} 
      <tr><td class="fl1"> Дата:          </td><td class="fl2"> <input id="dat" name="date"   type="date"   onChange="check()" value="{{ form.date.value }}"   /> </td> </tr>
      <tr><td class="fl1"> Количество:    </td><td class="fl2"> <input id="kol" name="kol"    type="number" step="0.001"  onChange="check()" value="{{ form.kol.value }}"    /> </td> </tr>
      <tr><td class="fl1"> Цена в рублях: </td><td class="fl2"> <input id="prc" name="price"  type="number" step="0.01"   onChange="check()" value="{{ form.price.value }}"  /> </td> </tr>
      <tr><td class="fl1"> Курс доллара:  </td><td class="fl2"> <input id="crs" name="course" type="number" step="0.0001" onChange="check()" value="{{ form.course.value }}" /> </td> </tr>
      <tr><td class="fl1"> Сумма в USD:   </td><td class="fl2"> <input id="usd" name="usd"    type="number" step="0.01"   onChange="check()" value="{{ form.usd.value }}"    /> </td> </tr>
      <tr><td class="fl1"> Итого в USD:   </td><td class="fl2"> <div id="total"> </div> </td> </tr>
      <tr><td class="fl1"> Контрагент:    </td><td class="fl2"> <input id="knt" name="kontr"  size="30" type="text"     onChange="check()" value="{{ form.kontr.value }}"  /> </td> </tr>
      <tr><td class="fl1"> Описание:      </td><td class="fl2"> <textarea id="txt" name="text" rows="3" cols="30" onChange="check()">{{form.text.value}}</textarea> </td> </tr>
    </tbody></table>

    <p id="status" class="PageStatus"> </p> 
    <p id="buttons"> </p> 
    <script language="javascript" type="text/javascript"> check() </script>
  </form>

  {% if opers.count %}
  <table class="work">
    <tbody><tr>
      <th class="work"> ID    </th>
      <th class="work"> Дата  </td>
      <th class="work"> USD   </td>
      <th class="work"> Контрагент </td>
      <th class="work"> Описание   </td>
    </tr>
    {% for g in opers %}
    <tr>
      <td class="pid">  <script language="javascript" type="text/javascript">getLink({{ g.id }})</script> </td>
      <td class="work"> {{ g.s_date }}    </td>
      <td class="numb"> {{ g.summa }}     </td>
      <td class="work"> {{ g.kontr_cut }} </td>
      <td class="work"> {{ g.text_cut }}  </td>
    </tr>
    {% endfor %}
  </tbody></table>
  {% endif %}

  <br/>Всего операций: {{ total_count }}<br/>

{% endblock %}
