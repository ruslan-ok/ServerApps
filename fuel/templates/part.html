{% extends "base.html" %}
{% load staticfiles %}
{% block content %}

  <script language="javascript" type="text/javascript">

    function getPartLink(_p)
    {
      var html = '<a href="/fuel/part/' + _p +'/">' + _p + '</a>';
      document.write(html);
      return true;
    }

    function getReplLink(_p, _r)
    {
      var html = '<a href="/fuel/repl/' + _p +'/">' + _r + '</a>';
      document.write(html);
      return true;
    }

    function addCommas(input) 
    {
      output = input.toString();
      var sRegExp = new RegExp('(-?[0-9]+)([0-9]{3})');
      while(sRegExp.test(output)) 
      {
        output = output.replace(sRegExp, '$1 $2');
      }

      if (output == '0')
        document.write('');
      else
        document.write(output);
    }

    function myClick(_num)
    {
      var frm = document.getElementById("fld_form");
      frm.Submit();
      return true;
    }

    bEdit = false;

    function check()
    {
      var name  = document.getElementById('fld_form').elements['name'].value;
      var km    = parseInt(document.getElementById('fld_form').elements['chg_km'].value);
      var mo    = parseInt(document.getElementById('fld_form').elements['chg_mo'].value);

      var status = '';
      if (name == '')
        status = 'Не задано наименование расходника';
      else
        if (isNaN(km) && isNaN(mo))
          status = 'Не задан интервал замены';
      
      
      document.getElementById('status').innerHTML = status;
      
      var x = document.getElementById('buttons');
      
      if (status != '')
      {
        if (!bEdit)
          x.innerHTML = '';
        else
          x.innerHTML = '<input type="submit" class="LiteButton" id="delete" name="action" value="Удалить"   onClick="myClick(3)" />' +
                        '<input type="submit" class="LiteButton" id="common" name="action" value="Отменить"  onClick="myClick(4)" />';
      }
      else
      {
        if (!bEdit)
          x.innerHTML = '<input type="submit" class="LiteButton" id="update" name="action" value="Добавить"  onClick="myClick(1)" />';
        else
          x.innerHTML = '<input type="submit" class="LiteButton" id="update" name="action" value="Сохранить" onClick="myClick(2)" />' +
                        '<input type="submit" class="LiteButton" id="delete" name="action" value="Удалить"   onClick="myClick(3)" />' +
                        '<input type="submit" class="LiteButton" id="common" name="action" value="Отменить"  onClick="myClick(4)" />';
      }
    }

    function countRest(chg_km, chg_mo, last_odo, last_date, fuel_odo, fuel_date)
    {
      if (isNaN(chg_km) && isNaN(chg_mo))
      {
        document.write('не задан интервал замены');
        return;
      }
      
      if ((fuel_odo == 0) || (fuel_date == ''))
      {
        document.write('нет информации о последней заправке');
        return;
      }

      if ((last_odo == 0) || (last_date == ''))
      {
        document.write('нет данных о последней замене');
        return;
      }

      var output = '';
      var p1 = '';
      var p2 = '';
      var m1 = false;
      var m2 = false;

      if (!isNaN(chg_km) && (chg_km != 0))
      {
        var trip_km = fuel_odo - last_odo; // Проехали км от последней замены

        if (trip_km > 1000)
          trip_km = Math.round((trip_km / 1000)) * 1000;

        if (trip_km > chg_km)
        {
          if (trip_km > 1000)
            p1 = 'просрочено на <span id="error">' + Math.round(((trip_km - chg_km) / 1000)) + ' тыс.</span> км';
          else
            p1 = 'просрочено на <span id="error">' + (trip_km - chg_km) + '</span> км';
          m1 = true;
        }
        else
          if ((chg_km - trip_km) < 1000)
            p1 = '<span id="warning">' + (chg_km - trip_km) + '</span> км';
          else
            p1 = Math.round(((chg_km - trip_km) / 1000)) + ' тыс. км';
      }

      if (!isNaN(chg_mo) && (chg_mo != 0))
      {
        var fd = new Date(fuel_date);
        var ld = new Date(last_date);
        var trip_days = ((fd.getTime() - ld.getTime()) / (24*60*60*1000)) - (chg_mo * 30.42);
        var per = '';
        var days = trip_days;
        if (days < 0)
          days = -1 * days;

        if (days < 2)
          per = 'день';
        else if (days < 5)
          per = Math.round(days) + ' дня';
        else if (days < 30)
          per = Math.round(days) + ' дней';
        else if (days < 45)
          per = 'месяц';
        else if (days < 135)
          per = Math.round(days/30) + ' месяца';
        else if (days < 270)
          per = 'пол года';
        else if (days < 540)
          per = 'год';
        else if (days < 1642)
          per = Math.round(days/365) + ' года';
        else
          per = Math.round(days/365) + ' лет';
        
        if (trip_days > 0)
        {
          p2 = 'просрочено на <span id="error">' + per + '</span>';
          m2 = true;
        }
        else
          if (days < 32)
            p2 = '<span id="warning">' + per + '</span>';
          else
            p2 = per;
      }

      if (m1)
        output = p1;
      else
        if (m2)
          output = p2;
        else
          if (p1 == '')
            output = p2;
          else 
            if (p2 == '')
              output = p1;
            else
              output = p1 + ' или ' + p2;

      document.write(output);
    }

  </script>
  
  <div id="gmenu" class="menu"> <a href="/">{{ app_text }}</a> | <a href="/fuel/">{{ fuel_text }}</a> </div> <br/>

  <div class="PageTitle">  {{ page_title  }} </div>
  <div class="PageStatus"> {{ page_status }} </div>

  {{ form.non_field_errors }}
  {% for field in form %}
    <div class="fieldWrapper"> {{ field.errors }} </div>
  {% endfor %}

  <form id="fld_form" action="{% url 'part' pid %}" method="post">
    {% csrf_token %}
    <table class="fl1">
      <tbody>
        <tr><td class="fl3"> Последняя заправка</td> <td class="fl2"></td> <td class="fl2"></td> </tr>
        <tr><td class="fl2"></td> <td class="fl1"> Дата:    </td><td class="fl2"> {{ fuel_date }} </td> </tr>
        <tr><td class="fl2"></td> <td class="fl1"> Одометр: </td><td class="fl2"> {{ fuel_odo  }} </td> </tr>
{% if last_date != "" and last_odo != 0 %}
        <tr><td class="fl3"> Последняя замена</td> <td class="fl2"></td> <td class="fl2"></td> </tr>
        <tr><td class="fl2"></td> <td class="fl1"> Дата: </td><td class="fl2"> {{ last_date }} </td> </tr>
        <tr><td class="fl2"></td> <td class="fl1"> Одометр: </td><td class="fl2"> {{ last_odo }} </td> </tr>
{% endif %}
      </tbody>
    </table>
    <table class="fl1">
      <tbody>
        {% if pid > 0 %} 
        <script language="javascript" type="text/javascript"> bEdit = true; </script>
        <tr><td class="fl1"> ID: </td><td class="fl2"> {{ pid }} </td> </tr>
        {% else %}
        <script language="javascript" type="text/javascript"> bEdit = false; </script>
        {% endif %}
        <tr><td class="fl1"> Наименование:         </td><td class="fl2"> <input name="name"   type="text"   value="{{ form.name.value }}"   onChange="check()" /> </td> </tr>
        <tr><td class="fl1"> Интервал замены, км:  </td><td class="fl2"> <input name="chg_km" type="number" value="{{ form.chg_km.value }}" onChange="check()" /> </td> </tr>
        <tr><td class="fl1"> Интервал замены, мес: </td><td class="fl2"> <input name="chg_mo" type="number" value="{{ form.chg_mo.value }}" onChange="check()" /> </td> </tr>
        <tr><td class="fl1"> Описание: </td> <td class="fl2">
           <textarea id="txt" name="comment" rows="3" cols="22"> {{ form.comment.value }} </textarea> </td> </tr>
      </tbody>
    </table>
    <span id="buttons"> </span> 
    <span id="status" class="PageStatus"> </span> 
    <script language="javascript" type="text/javascript"> check() </script>
  </form>

  {% if parts.count %}
  <table class="work">
    <tbody><tr>
      <th class="work"> ID           </th>
      <th class="work"> Наименование </th>
      <th class="work"> км           </th>
      <th class="work"> мес          </th>
      <th class="work"> Замены       </th>
      <th class="work"> Осталось     </th>
    </tr>
    {% for p in parts %}
    <tr>
      <td class="pid">  <script language="javascript" type="text/javascript">getPartLink({{ p.id }})</script> </td>
      <td class="work"> {{ p.name }} </td>
      <td class="numb"> <script language="javascript" type="text/javascript">addCommas({{ p.chg_km }}) </script> </td>
      <td class="numb"> <script language="javascript" type="text/javascript">addCommas({{ p.chg_mo }}) </script> </td>
      <td class="pid">  <script language="javascript" type="text/javascript">getReplLink({{ p.id }}, {{ p.repls }})</script> </td>
      <td class="numb"> <script language="javascript" type="text/javascript">
              countRest({{ p.chg_km }}, {{ p.chg_mo }}, {{ p.last_odo }}, "{{ p.s_last_date }}", {{ fuel_odo }}, "{{ fuel_date }}") </script> </td>
    </tr>
    {% endfor %}
  </tbody></table>
  {% endif %}

{% endblock %}

